version: v1.0
name: Recipe of Caching Big Repositories
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Reuse GitHub repository
    task:
      jobs:
      - name: Cache GitHub repository
        commands:
          - checkout
          - cd ..
          - echo $SEMAPHORE_GIT_DIR
          - cache store "$SEMAPHORE_GIT_REPO_NAME"-"$SEMAPHORE_GIT_SHA" "$SEMAPHORE_GIT_DIR"

  - name: Task 2 - Single Job
    task:
      jobs:
      - name: Use Cache - Job 1
        commands:
          - cache restore "$SEMAPHORE_GIT_REPO_NAME"-"$SEMAPHORE_GIT_SHA"
          - ls -al
          - ls -al "$SEMAPHORE_GIT_DIR"

  - name: Task 3 - Single Job
    task:
      jobs:
      - name: Use Cache - Job 2
        commands:
          - checkout
          - echo "make rspec"

  - name: Task 3 - Two jobs
    task:
      jobs:
      - name: Use Cache - Job 3
        commands:
          - checkout
          - echo "make cucumber"

      - name: Use Cache - Job 4
        commands:
          - checkout
          - echo "make docker.push"

